---
title: "Projet sujet 2"
author: "Omar Himych, Morgane Roy"
date: "03/03/2022"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r work, include =FALSE, cache=FALSE}
# set environment
WORK = "~/3A_202120222/Valeurs extrêmes/Projet/" #à modifier en local pour chacun
setwd(WORK)

library(dplyr)
library(ggplot2)
library(lubridate)
library(extRemes)
library(evd)

data <- load("data.RData")

data_df <<- select(data_df, "date", "var2") 
data2_df <<- select(data2_df, "date", "var3", "var4")

data_df_plot <- data_df

class(data_df$DATE)
#transform to appropriate time class:
data_df$date = as.POSIXlt(data_df$date)
years = 1900 + data_df$date$year
months = data_df$date$mon+1
table(months)
data_df$years = years
data_df$months = months

```
# Introduction

Dans le cadre du projet de valeurs extrêmes, nous avons eu le projet N°2. Pour les tâches 1 à 5 nous avons donc travaillé avec var2 pour *data_df*, et pour la suite, nous avons travaillé avec var3 et var4 pour *data2_df*.

***

# Tâche 1

Pour commencer, voici d'abord un résumé de nos données ainsi qu'un tracé temporel de toutes les données.
```{r warning=FALSE, fig.align='center'}

summary(data_df)

ggplot(data = data_df_plot,
       mapping = aes(x = date, y = var2)) + geom_line() + labs(
  title    = "Évolution temporelle de la variable étudiée",
  subtitle = "Tracé sur la totalité des dates fournies, début des mesures en 1971",
  x        = "Date",
  y        = "Variable")

# format date données : YYYY-MM-JJ

date_debut <- as.Date("2010-01-01","%Y-%m-%j")
date_fin <- as.Date("2019-12-31", "%Y-%m-%j")

ggplot(data = data_df_plot %>% filter(between(as.Date(date,origin="1970-01-01"), date_debut,date_fin)),
       mapping = aes(x = date, y = var2)) + geom_line() + labs(
  title    = "Évolution temporelle de la variable étudiée",
  subtitle = "Période restreinte aux années 2010",
  x        = "Date",
  y        = "Variable")

date_debut <- as.Date("2018-01-01","%Y-%m-%j")
date_fin <- as.Date("2018-12-31", "%Y-%m-%j")
ggplot(data = data_df_plot %>% filter(between(as.Date(date,origin="1970-01-01"), date_debut,date_fin)),
       mapping = aes(x = date, y = var2)) + geom_line()  + labs(
  title    = "Évolution temporelle de la variable étudiée",
  subtitle = "Tracé sur l'année 2018",
  x        = "Date",
  y        = "Variable")

hist(data_df$var2, breaks = 15, main = "Histogramme de la variable", xlab = "var2", ylab="Fréquence")

acf(data_df$var2, na.action = na.pass, xlab = "Lag (jours)", ylab="Auto-corrélation temporelle de var2", main="Auto-corrélation temporelle de la variable en fonction du lag")


```

Nous pouvons constater qu'il s'agit d'une variable avec une certaine saisonnalité, et qui semble atteindre ces valeurs les plus extrêmes en
été. Tout cela, en plus de l'échelle de valeurs (de ~7 à ~37) laisse penser à une température. Il s'agit également d'une variable ayant une majorité de valeurs vers 25/26, donc plutôt une région chaude, et qui est auto-corrélée dans le temps de manière assez significative.

# Tâche 2

```` {r, fig.align='center'}

extract_function = function(vec, nr_of_na_allowed = 30){
  if(sum(is.na(vec)) > nr_of_na_allowed){
    return(NA)
  }else{
    return(max(vec, na.rm = TRUE))
  }
}


tmp = aggregate(data_df$var2, by = list(year = data_df$years), FUN = extract_function)
mean(is.na(tmp$x)) # proportion of years with too many NA data
# observations of maxima
obs = tmp$x

ggplot(data = tmp,
       mapping = aes(x = year, y = x)) + geom_line()  + labs(
  title    = "Maxima annuel sur les années avec moins de 30 NA",
  x        = "Year",
  y        = "Maximum")


````

On constate une hausse des maxima annuels sur les années avec moins de 30 données NA.
Faisons maintenant l'estimation du modèle GEV stationnaire puis du modèle non-stationnaire.

```` {r, fig.align='center', warning=FALSE}

fit = fevd(na.omit(obs), type = "GEV", method = "MLE", period.basis = "year", use.phi = TRUE)
summary(fit)
plot(fit)

fit_nonstationnaire1 = fevd(na.omit(obs), data = data.frame(year = na.omit(tmp)$year), scale.fun = ~1+year, location.fun = ~1+year, type = "GEV", method = "MLE", period.basis = "year", use.phi = TRUE)
summary(fit_nonstationnaire1) 
plot(fit_nonstationnaire1)

````

Le modèle non-stationnaire a un output d'AIC plus faible, ce qui indique qu'il s'agit d'un modèle qui correspond mieux.
TODO : climate change effect ? OUI sûrement car les maxima ont augmenté

Calculons maintenant le 100-year return pour le modèle stationnaire et le modèle non-stationnaire pour 2020.
````{r}
# Estimate a 100-year return level for daily TAVG for the month January. 
T_january = 31 * 100 # in 100 years, we have T days in January


covar1 = cos(1:366/366*2*pi)
covar2 = sin(1:366/366*2*pi)
# For the shape parameter, we simply use the average of estimates for the month of January:
sigma_jan = mean(exp(sigma0 + covar1[1:31] + sigma2 * covar2[1:31]))
sigma_jan
xi = fit$results$par[4]
xi
names(xi) = NULL
u = u_by_month[1]  #threshold in January month

# By construction of the monthly thresholds above, the exceedance probability is as follows:
p_u = 1 - 0.975
x_T = u + sigma_jan * ((T_january*p_u)^xi-1)/xi
x_T 


````

# Tâche 3

```` {r}

````

# Tâche 4

Arguments pris en compte :
- Aucune température sous 6°C
- Moyenne vers 26
- Saisonnalité vers l'été, un peu avant
- 3/4 des températures au-dessus de 22°C
- Il fait déjà environ 25/30  en mai

==> Riyad Arabie Saoudite

# Tâche 5

````{r}

class(data2_df$date)
#transform to appropriate time class:
data2_df$date = as.POSIXlt(data2_df$date)
years = 1900 + data2_df$date$year
months = data2_df$date$mon+1
table(months)
data2_df$years = years
data2_df$months = months

chiplot(cbind(data2_df$var3, data2_df$var4), qlim = c(0.8, .9995), xlim = c(0.8, .9995), which = 1)


````
On constate bien que la tail correlation diminue très légèrement lorsque le palier quantile u augmente, et reste bien différent de 0 pour des quantiles élevés. On peut donc supposer qu'il n'y a pas de dépendance asymptotique.

```` {r}

M1 = aggregate(data2_df$var3, by = list(year = data2_df$years), FUN = max)$x
M2 = aggregate(data2_df$var4, by = list(year = data2_df$years), FUN = max)$x

omega = 0:26/26 # define values where to evaluate A
pickands = abvnonpar(omega, data = cbind(M1,M2), method = "cfg", plot = TRUE) 
````
On constate que les deux variables ne sont ni 100% indépendantes, ni 100% dépendantes. Cependant, elles paraissent plus indépendantes que l'inverse. On peut en déduire que si elles s'influencent entre elles, elles ne sont pas entièrement influentes sur l'autre.

